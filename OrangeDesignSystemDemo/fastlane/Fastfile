#
# Software Name: Orange Design System
# SPDX-FileCopyrightText: Copyright (c) Orange SA
# SPDX-License-Identifier: MIT
#
# This software is distributed under the MIT license,
# the text of which is available at https://opensource.org/license/MIT/
# or see the "LICENSE" file for more details.
#
# Authors: See CONTRIBUTORS.txt
# Software description: A SwiftUI components library with code examples for Orange Design System
#

# App features configuration
# --------------------------

APPS_PLUS_SERVICE_URL = ENV["ODS_APPS_PLUS_SERVICE_URL"]

# Apple configuration
# -------------------

APPLE_ISSUER_ID = ENV["ODS_APPLE_ISSUER_ID"]
APPLE_KEY_ID = ENV["ODS_APPLE_KEY_ID"]
APPLE_KEY_CONTENT = ENV["ODS_APPLE_KEY_CONTENT"]
DEVELOPER_APP_IDENTIFIER = ENV["ODS_DEVELOPER_APP_IDENTIFIER"]

# Notifications and hooks
# -----------------------

MATTERMOST_HOOK_URL = ENV["ODS_MATTERMOST_HOOK_URL"]
MATTERMOST_HOOK_BOT_NAME = ENV["ODS_MATTERMOST_HOOK_BOT_NAME"]
MATTERMOST_HOOK_BOT_ICON_URL = ENV["ODS_MATTERMOST_HOOK_BOT_ICON_URL"]

# Project configuration
# ---------------------

ODS_WORKSPACE = "OrangeDesignSystemDemo.xcworkspace"
ODS_PROJECT = "OrangeDesignSystemDemo.xcodeproj"
ODS_SCHEME = "OrangeDesignSystemDemo"

# Lanes
# ------

default_platform(:ios)

platform :ios do

  before_all do
    xcodes(select_for_current_build_only: true)
  end

  # ------------------------------------------------------------
  # ADD APPS PLUS CREDENTIALS (About module)
  # ------------------------------------------------------------
  desc "ADD APPS PLUS CREDENTIALS"
  lane :add_credentials_appsplus do
    if APPS_PLUS_SERVICE_URL.nil? || APPS_PLUS_SERVICE_URL.empty?
      publish_mattermost_notification("⚠️ @channel Warning: APPS_PLUS_SERVICE_URL is not defined, are you aware of that?")
    end

    update_plist(
      plist_path: "OrangeDesignSystemDemo/Resources/Info.plist",
      block: proc do |plist|
        plist[:APPS_PLUS_URL] = APPS_PLUS_SERVICE_URL
      end
    )
  end

  # ---------
  # RUN TESTS
  # ---------
  desc "RUN TESTS BY TRIGGERING THE TESTS PLANS OF THE PROJECT"
  lane :test do
    # Should have on runner one device under at least iOS 15
    # Check the available devices using `xcrun xctrace list devices`
    # Add new environments using `xcodebuild -downloadPlatform iOS`
    begin
        scan(scheme: "OrangeDesignSystemDemo")
        publish_mattermost_notification("🧪 ✅ No issue with tests")

    rescue => error
        publish_mattermost_notification("🧪 🚨 @channel Some issue occured with tests (:test)")
        raise error
    end
  end
    
  # ------------------------------------------------------------
  # ADD APPS PLUS CREDENTIALS (Recirculation Module)
  # ------------------------------------------------------------
  desc "ADD APPS PLUS CREDENTIALS"
  lane :add_credentials_appsplus do
    if APPS_PLUS_SERVICE_URL.nil? || APPS_PLUS_SERVICE_URL.empty?
      publish_mattermost_notification("⚠️ @channel Warning: APPS_PLUS_SERVICE_URL is not defined, are you aware of that?")
    end

    update_plist(
      plist_path: "OrangeDesignSystemDemo/Resources/Info.plist",
      block: proc do |plist|
        plist[:APPS_PLUS_URL] = APPS_PLUS_SERVICE_URL
      end
    )
  end

  # ------------------------------------------------------------
  # UPDATE BUILD NUMBER WITH TIMESTAMP
  # ------------------------------------------------------------
  desc "UPDATE BUILD NUMBER WITH TIMESTAMP"
  lane :increment do
    timestamp = sh 'date +%s'
    timestamp = timestamp.strip!
    increment_build_number(xcodeproj: ODS_PROJECT, build_number: timestamp)
  end

  # ------------------------------------------------------------
  # READ AND SET NEXT RELEASE NOTE IN CHANGELOG
  # ------------------------------------------------------------
  desc "READ AND SET NEXT RELEASE NOTE IN CHANGELOG"
  lane :prepare_release do
    version = get_app_version

    stamp_changelog(
        changelog_path: '../CHANGELOG.md',
        section_identifier: version,
        git_tag: version,
        should_stamp_date: true,
        stamp_datetime_format: '%F'
    )
  end

  # ------------------------------------------------------------
  # BUILD DEBUG APP
  # ------------------------------------------------------------
  desc "BUILD DEBUG APP"
  lane :buildDebugApp do
    cocoapods(
      clean_install: true
    )
    gym(
      scheme: ODS_SCHEME,
      output_directory: 'build/',
      archive_path: 'build/',
      output_name: 'odsApp',
      configuration: 'Debug',
      include_symbols: true,
      export_method: 'development'
    )
  end

  # ------------------------------------------------------------
  # BUILD & UPLOAD TO TESTFLIGHT QUALIF APP
  # ------------------------------------------------------------
  desc "BUILD & UPLOAD TO TESTFLIGHT QUALIF APP"
  lane :qualif do
    puts "This is a dumb 'puts' to ensure the 'Appfile' is read!"
    Dir.chdir "../OrangeDesignSystemDemo/Resources/Assets.xcassets" do
        sh "rm -Rf AppIconRelease.appiconset"
        sh "cp -R AppIconQualif.appiconset AppIconRelease.appiconset"
    end

    set_info_plist_value(path: "#{Dir.pwd}/../OrangeDesignSystemDemo/Resources/Info.plist", key: "ODSBuildType", value: "BETA")
    
    build_and_upload(upload: true)
  end

  # ------------------------------------------------------------
  # BUILD & UPLOAD TO TESTFLIGHT PROD APP
  # ------------------------------------------------------------
  desc "BUILD & UPLOAD TO TESTFLIGHT (if set in options: upload) PROD APP"
  lane :prod do |options|
    puts "This is a dumb 'puts' to ensure the 'Appfile' is read!"
    build_and_upload(options)
  end

  # -----------------------------------------------------------------------
  # PRIVATE LANE BUILD & UPLOAD (DEV / QUALIF / PROD is set by main lane)
  # -----------------------------------------------------------------------
  private_lane :build_and_upload do |options|
    build
    tag_ci_build
    if options[:upload]
      puts "Upload to TestFlight requested"
      upload
      tag_testflight_build
    else
      puts "Upload to TestFlight not requested"
    end
  end

  # -----------------------------------------------------------------------
  # PRIVATE LANE BUILD (DEV / QUALIF / PROD is set by main lane)
  # -----------------------------------------------------------------------
  desc "PRIVATE LANE BUILD (DEV / QUALIF / PROD is set by main lane)"
  private_lane :build do
    begin
        update_app_identifier(
            xcodeproj: "#{ODS_PROJECT}",
            plist_path: "OrangeDesignSystemDemo/Resources/Info.plist",
            app_identifier: CredentialsManager::AppfileConfig.try_fetch_value(:app_identifier)
        )

        increment

        cocoapods(
            clean_install: true
        )

        build_app(
            workspace: ODS_WORKSPACE,
            clean: true,
            scheme: ODS_SCHEME,
            output_directory: 'build/',
            archive_path: 'build/odsApp.xcarchive',
            output_name: 'odsApp',
            configuration: 'Release',
            include_symbols: true,
            export_method: 'app-store',
            xcargs: '-allowProvisioningUpdates'
        )
        
        publish_mattermost_notification("🔨 ✅ @channel A new build has been done successfully")
    rescue => error
        publish_mattermost_notification("🔨 🚨 @channel Some issue occurred during the build step (:build_and_upload)")
        raise error
    end
  end
  
  # -----------------------------------------------------------------------
  # PRIVATE LANE TO CREATE GIT TAG FOR CI
  # -----------------------------------------------------------------------
  private_lane :tag_ci_build do
    begin

        # Create a tag dedicated to the CI/CD builds using the updated app build number
        build_number = get_build_number(xcodeproj: ODS_PROJECT)
        expected_git_tag = "ci/" + build_number

        sh "git tag #{expected_git_tag}"
        sh "git push origin #{expected_git_tag}"

        publish_mattermost_notification("📦 ✅ New Git tag created: #{expected_git_tag}")
    rescue => error
        publish_mattermost_notification("📦 🚨 @channel Some issue occurred during the tagging step (:tag_build)")
        raise error
    end
  end

  # -----------------------------------------------------------------------
  # PRIVATE LANE TO CREATE GIT TAG FOR TESTFLIGHT BUILD
  # -----------------------------------------------------------------------
  private_lane :tag_testflight_upload do
    begin

        # Create a tag dedicated to the CI/CD builds for TestFlight using the updated app build number
        build_number = get_build_number(xcodeproj: ODS_PROJECT)
        expected_git_tag = "Test_Flight/" + build_number

        sh "git tag #{expected_git_tag}"
        sh "git push origin #{expected_git_tag}"

        publish_mattermost_notification("📦 ✅ New Git tag created: #{expected_git_tag}")
    rescue => error
        publish_mattermost_notification("📦 🚨 @channel Some issue occurred during the tagging step (:tag_build)")
        raise error
    end
  end

  # -----------------------------------------------------------------------
  # PRIVATE LANE UPLOAD TO TESTFLIGHT (DEV / QUALIF / PROD is set by main lane)
  # -----------------------------------------------------------------------
  desc "PRIVATE LANE UPLOAD TO TESTFLIGHT"
  private_lane :upload do
    begin
        api_key = app_store_connect_api_key(
          key_id: APPLE_KEY_ID,
          issuer_id: APPLE_ISSUER_ID,
          key_content: APPLE_KEY_CONTENT,
          duration: 500,
          in_house: false
        )
        
        TESTFLIGHT_GROUPS = ENV['TESTFLIGHT_GROUPS']
        
        version = get_app_version
        puts version

        build_number = get_build_number(xcodeproj: ODS_PROJECT)
        puts build_number

        news = read_current_release_notes

        upload_to_testflight(
            changelog: news,
            app_identifier: "#{DEVELOPER_APP_IDENTIFIER}",
            skip_submission: false,
            skip_waiting_for_build_processing: false,
            distribute_external: true,
            notify_external_testers: true,
            groups: TESTFLIGHT_GROUPS,
            api_key: api_key
        )
        
        publish_mattermost_notification("📦 ✅ @channel The upload to TestFlight has been done successfully")
        
    rescue => error
        publish_mattermost_notification("📦 🚨 @channel Some issue occurred during the upload step (:build_and_upload)")
        raise error
    end
  end
  
  # -----------------------------------------
  # PRIVATE LANE FOR MATTERMOST NOTIFICATIONS
  # -----------------------------------------
  def publish_mattermost_notification(message)
      mattermost(url: MATTERMOST_HOOK_URL,
                 text: message,
                 username: MATTERMOST_HOOK_BOT_NAME,
                 icon_url: MATTERMOST_HOOK_BOT_ICON_URL
                 )
  end

  # -------
  # Helpers
  # -------

  # Get version set in the Xcode project
  def get_app_version
    version = get_version_number(
        xcodeproj: ODS_PROJECT,
        target: ODS_SCHEME
    )
    return version
  end

  # Read release note in section associated to the current version
  # If empty, try within the Unreleased section
  def read_current_release_notes
    version = get_app_version

    changelog=read_changelog(
        changelog_path: '../CHANGELOG.md',
        section_identifier: "[#{version}]",
    )

    if changelog == ""
        changelog=read_changelog(
            changelog_path: '../CHANGELOG.md',
            section_identifier: "[Unreleased]",
        )
    end

    puts "Current relase notes = #{changelog}"
    return changelog
  end

end
